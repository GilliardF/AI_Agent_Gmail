name: Build and Deploy AI Agent to Azure

on:
  push:
    branches:
      - login  # Aciona na branch 'login'
  workflow_dispatch:

env:
  # Valores preenchidos com base na sua imagem do Azure Portal
  WEB_APP_NAME: ai-agent
  ACR_NAME: acraigagentgilliard
  RESOURCE_GROUP: ai_agent
  
  # Nome da imagem Docker a ser criada
  DOCKER_IMAGE_NAME: ai-agent-gmail

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Loga no Azure usando o método seguro OpenID Connect.
      # Os secrets de CLIENTID, TENANTID e SUBSCRIPTIONID são criados e gerenciados pelo Azure quando você conecta o GitHub.
      # VERIFIQUE O NOME EXATO DESSES SECRETS NAS CONFIGURAÇÕES DO SEU REPOSITÓRIO.
      - name: Log in to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZUREAPPSERVICE_CLIENTID_... }}
          tenant-id: ${{ secrets.AZUREAPPSERVICE_TENANTID_... }}
          subscription-id: ${{ secrets.AZUREAPPSERVICE_SUBSCRIPTIONID_... }}

      # Loga no seu Azure Container Registry (ACR)
      - name: Log in to ACR
        run: az acr login --name ${{ env.ACR_NAME }}

      # Constrói a imagem Docker e envia para o ACR
      - name: Build and push image to ACR
        run: |
          docker build . --file Dockerfile --tag ${{ env.ACR_NAME }}.azurecr.io/${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}
          docker push ${{ env.ACR_NAME }}.azurecr.io/${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push # Só roda depois que o job anterior terminar com sucesso
    environment:
      name: 'Production'
      url: ${{ steps.deploy-to-webapp.outputs.webapp-url }}

    steps:
      - name: Log in to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZUREAPPSERVICE_CLIENTID_... }}
          tenant-id: ${{ secrets.AZUREAPPSERVICE_TENANTID_... }}
          subscription-id: ${{ secrets.AZUREAPPSERVICE_SUBSCRIPTIONID_... }}

      # Configura TODAS as variáveis de ambiente que sua aplicação precisa
      - name: Set Web App settings
        uses: Azure/appservice-settings@v1
        with:
          app-name: ${{ env.WEB_APP_NAME }}
          app-settings-json: |
            [
              { "name": "DOCKER_REGISTRY_SERVER_URL", "value": "https:// ${{ env.ACR_NAME }}.azurecr.io" },
              { "name": "POSTGRES_DB", "value": "${{ secrets.POSTGRES_DB }}" },
              { "name": "POSTGRES_USER", "value": "${{ secrets.POSTGRES_USER }}" },
              { "name": "POSTGRES_PASSWORD", "value": "${{ secrets.POSTGRES_PASSWORD }}" },
              { "name": "POSTGRES_HOST", "value": "${{ secrets.POSTGRES_HOST }}" },
              { "name": "POSTGRES_PORT", "value": "5432" },
              { "name": "ENCRYPTION_KEY", "value": "${{ secrets.ENCRYPTION_KEY }}" },
              { "name": "WEBSITES_PORT", "value": "8000" }
            ]

      # Pega a nova imagem do ACR e a implanta no App Service
      - name: Deploy to Azure Web App
        id: deploy-to-webapp
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.WEB_APP_NAME }}
          images: ${{ env.ACR_NAME }}.azurecr.io/${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}
