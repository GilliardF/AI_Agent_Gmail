name: Build and Deploy to Azure

on:
  push:
    branches:
      - login # Aciona na branch 'login'
  workflow_dispatch:

env:
  # MUDE AQUI com os nomes dos seus recursos do Azure
  WEB_APP_NAME: ai-agent
  ACR_NAME: acraigagentgilliard

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Log in to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZUREAPPSERVICE_PUBLISHPROFILE_... }} # Use o nome exato do secret que o Azure criou

      - name: Log in to ACR
        run: az acr login --name ${{ env.ACR_NAME }}

      - name: Build and push image to ACR
        run: |
          docker build . --file Dockerfile --tag ${{ env.ACR_NAME }}.azurecr.io/ai-agent-gmail:${{ github.sha }}
          docker push ${{ env.ACR_NAME }}.azurecr.io/ai-agent-gmail:${{ github.sha }}

  deploy:
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: 'Production'
      url: ${{ steps.deploy-to-webapp.outputs.webapp-url }}

    steps:
      - name: Log in to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZUREAPPSERVICE_PUBLISHPROFILE_... }} # Use o nome exato do secret que o Azure criou

      # Configura as vari√°veis de ambiente no App Service
      - name: Set Web App settings
        uses: Azure/appservice-settings@v1
        with:
          app-name: ${{ env.WEB_APP_NAME }}
          app-settings-json: |
            [
              { "name": "DOCKER_REGISTRY_SERVER_URL", "value": "https://${{ env.ACR_NAME }}.azurecr.io" },
              { "name": "POSTGRES_DB", "value": "${{ secrets.POSTGRES_DB }}" },
              { "name": "POSTGRES_USER", "value": "${{ secrets.POSTGRES_USER }}" },
              { "name": "POSTGRES_PASSWORD", "value": "${{ secrets.POSTGRES_PASSWORD }}" },
              { "name": "POSTGRES_HOST", "value": "${{ secrets.POSTGRES_HOST }}" },
              { "name": "POSTGRES_PORT", "value": "5432" },
              { "name": "ENCRYPTION_KEY", "value": "${{ secrets.ENCRYPTION_KEY }}" },
              { "name": "WEBSITES_PORT", "value": "8000" }
            ]

      # Faz o deploy da imagem do ACR para o App Service
      - name: Deploy to App Service
        id: deploy-to-webapp
        uses: azure/webapps-deploy@v2
        with:
          app-name: ${{ env.WEB_APP_NAME }}
          images: ${{ env.ACR_NAME }}.azurecr.io/ai-agent-gmail:${{ github.sha }}
